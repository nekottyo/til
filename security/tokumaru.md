体系的に学ぶ安全な Web アプリケーションの作り方
=====

# 3.1
## GET POST の使い分け

以下に当てはまる場合は `POST`, 当てはまらない場合は `GET` を使う
- 副作用があるリクエスト
- 機密データ
- 総量が多い場合

## セッションID
### 要件
セッション ID を第三者
1. が推測できないこと
2. から強制されないこと
3. に漏洩しないこと

### セッションID は自作しない

ツールのセッション ID 管理機能を使う

### セッションID は認証した後に変更する

1. 攻撃者認証前にセッション ID もらう
2. そのセッション ID を正規利用者が認証
3. 攻撃者がセッション ID つきでアクセス

###　クッキーの `Domain` 属性は指定しない

サブドメインでも使えちゃう

### クッキーの HttpOnly はつけてもいいかも

JavaScript から取れなくなる

# 3.2
## 同一生成元ポリシー
JavaScript のポリシー
- 同一 FQDN である
- 同一プロトコルである
- 同一ポートである

一方でクッキーはプロトコルとポートは見ない。JavaScript は path がない

同一性制限ポリシーを回避する代表的なのが XSS

# 4.2
## 入力処理とセキュリティ

入力処理は
- エンコーディング検証
- エンコーディング変換
- パラメータ文字列の検証


入力処理の最低基準
- 入力値検証はアプリケーション要件が基準で行う
- 文字エンコーディングの検証
- 制御文字を含む文字種の検証
- 文字列長の検証
- 全てのパラメータで検証する
  - hidden とか referer とか http header とか　
- 全てのパラメータで文字種と最大文字列を設定する


# 4.3 表示処理

- `><%"''"` は文字実態参照に変換する
- 属性値はエスケープ後にダブルクオートで囲む
- レスポンスは `Content-Type, charest` を明示
- 入力値検証
- クッキーに HttpOnly
- TRACE メソッド無効
- JS 動的生成
  - Unicode 文字にする
- DOM based XSS
  - クエリパラメータを元に画面描画する場合
  - エスケープするライブラリを使う
- console エラーメッセージは利用者向けにする

# 4.4 SQLインジェクション

文字列リテラルがはみ出ることが問題

- プレースホルダをつかう
- 静的プレースホルダを強く推奨
- 詳細なエラーメッセージを見せない
- 権限設定を細かくする
- 入力値の妥当性検証

# 4.5 重要な処理に混入する脆弱性

クレカや送金、メール送信やパスワード変更などをが重要な処理

## 4.5.1 クロスサイトリクエストフォージェリ CSRF

XSS との違いはサーバ側で実行される脆弱性。
内容はサーバ側で用意された処理に限定される


`hidden` 属性などで隠しながら正規の利用者の権限で内容を変更したりできる。
セッション変数でパラメータ受け渡しでも iframe 2 個とか使って攻撃が成立する

対策

- CSRF 対策の必要なページを区別　
  - EC サイトは実際に商品を購入するリクエストや個人情報を変更するリクエスト
- 正規利用者の意図したリクエストを区別
  - トークン
    - 前のページにトークン埋め込んどいて、遷移先で検証する
  - パスワード再入力
  - Referer チェック
- 重要な処理の後にメールを飛ばす
  - (パスワードなどの）重要な内容は含まないように

# 4.6 セッション管理の不備
## 4.6.1 セッションハイジャック

セッション ID の
- 推測
- 盗み出し
- 強制

## 4.6.2 推測可能な セッションID

攻撃手法
- セッション ID を集める
- 規則性の仮設を建てる
- 推測したセッション ID を試す

有りがちな生成方法
- user id , mail address
- IP address
- unix time, datetime
- 乱数

対策
- 自分でセッション管理機能を作らない
- クッキーにセション ID を入れる

## 4.6.3 セッションID の固定

攻撃手法
- セッション ID を入手
- 攻撃者がセッション ID を強制
- 被害者がログイン
- 攻撃者がそのセッション ID を利用

対策
- 認証後にセッション ID を変更する

# 4.7 リダイレクト処理にまつわる脆弱性
## 4.7.1 オープリンダイレクタ

攻撃手法
- リダイレクト先を罠サイトにしていておいてその URL を踏ませる

対策
- リダイレクト先を固定する
- リダイレクト先を直接指定しない
- ドメインチェックをする
- (直接の対策ではないが）クッションページを用意する

## 4.7.2 HTTP ヘッダインジェクション

攻撃手法
- リダイレクト先 URL, クッキーとな r URL パラメータの中に改行入れてヘッダをいじる

対策
- 外部パラメータを　 HTTP レスポンスヘッダにしない
- 切所変数で URL を受け渡す
- API に任せる
- 改行文字チェック

# 4.8 クッキーにまつわる脆弱性
## 4.8.1 クッキーの不適切な利用

そもそもクッキーにはデータを保存しないほうがいい。ログイン保持とかでもトークンを保存すべき

## 4.8.2 クッキーのセキュア属性不備

https only なページは全部セキュア属性をつける

# 4.9 メール送信問題
## 4.9.1 メールヘッダインジェクション　


メールのヘッダ要素になる部分に改行入れるとメールヘッダになる
あるいは複数改行で本文を入れることにより攻撃される

対策
- ライブラリを使う
- 外部からヘッダのパラメータを読み込まない
- パラメータは改行をチェックをする
- 制御文字弾く

# 4.10 ファイルアクセスにまつわる脆弱性
## 4.10.1 ディレクトリトラバーサル

対策
- 外部からファイル名を指定させない
- ファイル名にディレクトリを含ませない
- 受け入れ文字種を限定する


## 4.10.2 意図しないファイル公開

対策
- ディレクトリリスティングを落とす

# 4.11 OS コマンド呼び出しに関する脆弱性
## 4.11.1 OS コマンドインジェクション

- OS コマンド呼び出しを使わない
- シェル呼び出し機能つきの関数を使わない
- そのままコマンドラインパラメータに渡さない
- 安全な関数でエスケープする
- ホスト側実行ユーザの権限を縛る

# 4.12 ファイルアップロード問題

対策
- ファイルを公開ディレクトリに保存しない
- スクリプトとして実行可能な拡張子にしない

## 4.12.3 ファイルダウンロードXSS
画像の中に HTML タグが含まれているとブラウザが HTML と認識することがある

対策
- `Content-Type` を正しく指定する
- 拡張子と magic-byte が一致しているか
- レスポンスヘッダに `Content-Disposition: attachment` をつける

# 4.13 インクルード問題
## 4.13.1 ファイルインクルード攻撃

- 外部からファイル名を指定させない
- ファイル名にディレクトリを含めない
- ファイル名を英数字にする

# 4.14 eval 問題
## 4.14.1 eval インジェクション
対策
- eval を使わない
- 外部パラメータを含めない
- 英数字に限定する

# 4.15 共有資源問題

## 4.15.1 競合状態の脆弱性(Race Condition)
対策
- 共有資源を使わない
- 排他制御をする

-----
# 5.1 認証
不正ログインを防ぐために
- セキュリティバグをなくす
- パスワードを予測困難なものにする
  - 文字種制限、桁数制限、ID とかぶらせない、有りがちな単語を縛るなど
- アカウントロック
- PCI DSS

総当り攻撃のバリエーション
- 辞書攻撃
  - パスワード変えて攻撃
- ジョーアカウント探索
  - ユーザとパスワードを同じにして攻撃
- 逆総当たり攻撃
  - ユーザ変えて攻撃

対策
- 積極的なパスワードチェック
  - 簡単なの拒否る
- ログイン ID の秘匿
  - アカウントではなくメールアドレスで認証させる
- ログイン失敗率の監視

## 5.1.3 パスワード保存方法
メッセージダイジェスト

- パスワードをハッシュにかけてその値を保存
- ハッシュ関数選定に注意
  - 一方向性
  - 衝突耐性

攻撃手法
- オフライン総当り攻撃
- レインボークラック
- 攻撃者によるパスワード辞書の作成

対策
- ソルト
- ストレッチング
  - 例）ユーザ ID に固定長文字列をつけてバイナリ文字列をソルトとしてハッシュ値にソルトとパスワードくっつけて sha-256 に N 回通す

自動ログインについて
- セッションタイムアウトの延長
- トークン
- 認証チケット

## 5.1.5 ログインフォーム

- パスワード入力欄はマスクする？
- https 使う
- エラー表示は何で失敗したか表示しない
  - 例）`ID または パスワードが違うか、アカウントロックされています`

## 5.1.7 ログアウト機能

- ログアウト処理は副作用があるので POST にする
- ログアウト処理ではセッションを履き
- 必要な場合 CSRF 対策をする

# 5.2 アカウント管理

## 5.2.1 ユーザ登録
- メールアドレスの受信確認
  1. メールにトークン付き URL を添付してメールクリックで処理継続
    - 操作性いいけど実装面倒、メールの url クリックさせたくない
  2. トークン入力画面に遷移して、メールのアドレスにトークンを送りつけてそのトークンを入れてもらう
    - 実装簡単だがメールをすぐ受け取れないとだめ
- ユーザ ID の重複防止
  - UNIQUE つけたほうがいいよ
- 自動登録対策には CAPTCHA

## 5.2.2 パスワード変更
- 現在のパスワードを再確認する
- 変更通知をメールでする

## 5.2.3 メールアドレスの変更
- 新規メールアドレスの受信確認
- 再認証
- メール通知（新旧両方）

## 5.2.4 パスワードリマインダ
いわゆるパスワード忘れ

管理者向け
- ユーザのパスワードリセット
- 管理者の仮パスワード発行

利用者向け
- 秘密の質問（非推奨）
- メールアドレスへの通知
  - パスワード変更 URL 通知（メールクリックさせたくないので非推奨）
  - 仮パスワードの発行
    - メールアドレス入力 -> 秘密の質問 -> 再発行
  - メールにトークン発行 -> トークン入力 -> 秘密の質問 -> 再発行

いずれもメールアドレスがなくても遷移する

## 5.2.6 アカウント削除
パスワード再入力要求をする

## まとめ
共通して混入しやすい
- SQL インジェクション
- CSRF 脆弱性
- メールヘッダインジェクション

# 5.3 認可

## 5.3.2 認可不備
- パラメータ変更すると権限外の情報見れちゃう
  - hidden やクッキー書き換えでも起こる
- URL 直指定で権限外見れる

## 権限制御の要件定義
- 権限マトリックスを書く
  - 管理者とユーザ管理者とユーザ role でなにが出来てなにが出来ないか
- 認証情報は外部から書き換えれない切所変数に保持する

# 5.4 ログ

## 5.4.1 種類
- アクセスログ
- エラーログ
- デバッグログ
  - 本番で入れない

# 出力
- イベント　
  - ログインログアウト
  - アカウントロック
  - ユーザ登録削除
  - パスワード変更
  - 重要情報の参照
  - 重要操作
- 項目
  - 日時
  - IP address
  - User ID
  - アクセス対象
  - 操作内容
  - 捜査対象
  - 結果

# 6.1 文字コード
- 全体で文字集合を unicode で統一する
- 入力時に不正なエンコーディングをエラーにする
- 処理でエンコーディングを正しく扱う
- 出力時にエンコードを正しく指定する
- DB のエンコードを正しく指定する

# 6.1 Web サーバの攻撃と対策　
- 不要なソフトウェアは稼働させない
- 脆弱性対処をすぐやる
- global 公開不要なポートやサービスはアクセス制御
- 認証強くする
- https にしてちゃんと証明書買う
  - ものによっては let's encrypt でも
