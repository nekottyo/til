体系的に学ぶ安全な Web アプリケーションの作り方
=====

# 3.1
## GET POST の使い分け

以下に当てはまる場合は `POST`, 当てはまらない場合は `GET` を使う
- 副作用があるリクエスト
- 機密データ
- 総量が多い場合

## セッションID
### 要件
セッションID を第三者
1. が推測できないこと
2. から強制されないこと
3. に漏洩しないこと

### セッションID は自作しない

ツールのセッションID 管理機能を使う

### セッションID は認証した後に変更する

1. 攻撃者認証前にセッションID もらう
2. そのセッションID を正規利用者が認証
3. 攻撃者がセッションID つきでアクセス

###　クッキーの `Domain` 属性は指定しない

サブドメインでも使えちゃう

### クッキーの HttpOnly はつけてもいいかも

JavaScript から取れなくなる

# 3.2
## 同一生成元ポリシー
JavaScript のポリシー
- 同一FQDNである
- 同一プロトコルである
- 同一ポートである

一方でクッキーはプロトコルとポートは見ない。JavaScript は path がない

同一性制限ポリシーを回避する代表的なのが XSS

# 4.2
## 入力処理とセキュリティ

入力処理は
- エンコーディング検証
- エンコーディング変換
- パラメータ文字列の検証


入力処理の最低基準
- 入力値検証はアプリケーション要件が基準で行う
- 文字エンコーディングの検証
- 制御文字を含む文字種の検証
- 文字列長の検証
- 全てのパラメータで検証する
  - hidden とか referer とか http header とか　
- 全てのパラメータで文字種と最大文字列を設定する


# 4.3 表示処理

- `><%"''"` は文字実態参照に変換する
- 属性値はエスケープ後にダブルクオートで囲む
- レスポンスは `Content-Type, charest` を明示
- 入力値検証
- クッキーに HttpOnly
- TRACE メソッド無効
- JS 動的生成
  - Unicode 文字 にする
- DOM based XSS
  - クエリパラメータを元に画面描画する場合
  - エスケープするライブラリを使う
- console エラーメッセージは利用者向けにする

# 4.4 SQLインジェクション

文字列リテラルがはみ出ることが問題

- プレースホルダをつかう
- 静的プレースホルダを強く推奨
- 詳細なエラーメッセージを見せない
- 権限設定を細かくする
- 入力値の妥当性検証

# 4.5 重要な処理に混入する脆弱性

クレカや送金、メール送信やパスワード変更などをが重要な処理

## 4.5.1 クロスサイトリクエストフォージェリ CSRF

XSS との違いはサーバ側で実行される脆弱性。
内容はサーバ側で用意された処理に限定される


`hidden` 属性などで隠しながら正規の利用者の権限で内容を変更したりできる。
セッション変数でパラメータ受け渡しでも iframe 2個とか使って攻撃が成立する

対策

- CSRF 対策の必要なページを区別　
  - ECサイトは実際に商品を購入するリクエストや個人情報を変更するリクエスト
- 正規利用者の意図したリクエストを区別
  - トークン
    - 前のページにトークン埋め込んどいて、遷移先で検証する
  - パスワード再入力
  - Referer チェック
- 重要な処理の後にメールを飛ばす
  - (パスワードなどの)重要な内容は含まないように

# 4.6 セッション管理の不備
## 4.6.1 セッションハイジャック

セッションID の
- 推測
- 盗み出し
- 強制

## 4.6.2 推測可能な セッションID

攻撃手法
- セッションID を集める
- 規則性の仮設を建てる
- 推測したセッションIDを試す

有りがちな生成方法
- user id , mail address
- IP address
- unix time, datetime
- 乱数

対策
- 自分でセッション管理機能を作らない
- クッキーにセションID を入れる

## 4.6.3 セッションID の固定

攻撃手法
- セッションID を入手
- 攻撃者がセッションIDを強制
- 被害者がログイン
- 攻撃者がそのセッションID を利用

対策
- 認証後にセッションID を変更する

# 4.7 リダイレクト処理にまつわる脆弱性
## 4.7.1 オープリンダイレクタ

攻撃手法
- リダイレクト先を罠サイトにしていておいてその URL を踏ませる

対策
- リダイレクト先を固定する
- リダイレクト先を直接指定しない
- ドメインチェックをする
- (直接の対策ではないが)クッションページを用意する

## 4.7.2 HTTP ヘッダインジェクション

攻撃手法
- リダイレクト先URL, クッキーとなｒ URL パラメータの中に改行入れてヘッダをいじる

対策
- 外部パラメータを　 HTTP レスポンスヘッダにしない
- 切所変数で URL を受け渡す
- API に任せる
- 改行文字チェック

# 4.8 クッキーにまつわる脆弱性
## 4.8.1 クッキーの不適切な利用

そもそもクッキーにはデータを保存しないほうがいい。ログイン保持とかでもトークンを保存すべき

## 4.8.2 クッキーのセキュア属性不備

https only なページは全部セキュア属性をつける

# 4.9 メール送信問題
## 4.9.1 メールヘッダインジェクション　


メールのヘッダ要素になる部分に改行入れるとメールヘッダになる
あるいは複数改行で本文を入れることにより攻撃される

対策
- ライブラリを使う
- 外部からヘッダのパラメータを読み込まない
- パラメータは改行をチェックをする
- 制御文字弾く

# 4.10 ファイルアクセスにまつわる脆弱性
## 4.10.1 ディレクトリトラバーサル

対策
- 外部からファイル名を指定させない
- ファイル名にディレクトリを含ませない
- 受け入れ文字種を限定する


## 4.10.2 意図しないファイル公開

対策
- ディレクトリリスティングを落とす

# 4.11 OS コマンド呼び出しに関する脆弱性
## 4.11.1 OS コマンドインジェクション

- OS コマンド呼び出しを使わない
- シェル呼び出し機能つきの関数を使わない
- そのままコマンドラインパラメータに渡さない
- 安全な関数でエスケープする
- ホスト側実行ユーザの権限を縛る

# 4.12 ファイルアップロード問題

対策
- ファイルを公開ディレクトリに保存しない
- スクリプトとして実行可能な拡張子にしない
